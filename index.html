<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce Test Observability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .auth-bg {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://www.nexteraenergy.com/content/dam/nee/us/en/images/hero/nee-home-hero.jpg') no-repeat center center;
            background-size: cover;
        }
        .card-glass {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.8);
        }
        .chatbot-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3b82f6;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            z-index: 100;
        }
        .chatbot-icon:hover {
            transform: scale(1.1);
        }
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .project-btn {
            transition: all 0.3s ease;
        }
        .project-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .timeline-item {
            position: relative;
            padding-left: 1.5rem;
            margin-bottom: 2rem;
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 100%;
            background-color: #3b82f6;
        }
        .timeline-item:last-child:before {
            display: none;
        }
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #3b82f6;
            border: 3px solid white;
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            color: #374151;
            background-color: white;
            transition: all 0.3s ease;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #3b82f6;
            color: white;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .logo-clickable {
            cursor: pointer;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center auth-bg">
        <div class="w-full max-w-md mx-auto p-8 card-glass rounded-xl shadow-2xl">
            <div class="text-center mb-8">
                <img src="https://via.placeholder.com/150x50.png?text=Logo" alt="Company Logo" class="mx-auto h-16">
                <h1 class="text-3xl font-bold text-gray-800 mt-4">Welcome Back</h1>
                <p class="text-gray-600">Please sign in to access your dashboard</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">User ID</label>
                    <div class="mt-1">
                        <input id="username" name="username" type="text" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400">
                    </div>
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <div class="mt-1">
                        <input id="password" name="password" type="password" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400">
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-700">Remember me</label>
                    </div>
                    
                    <div class="text-sm">
                        <a href="#" class="font-medium text-blue-600 hover:text-blue-500">Forgot your password?</a>
                    </div>
                </div>
                
                <div>
                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">Sign in</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Screen (hidden initially) -->
    <div id="dashboard-screen" class="min-h-screen hidden">
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <img id="dashboard-logo" src="https://via.placeholder.com/150x50.png?text=Logo" alt="Logo" class="h-10 mr-4 logo-clickable">
                    <h1 class="text-2xl font-bold text-gray-900">Salesforce Test Observability</h1>
                </div>
                <div class="flex space-x-2">
                    <button id="logout-btn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition duration-150">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test1">Test 1</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test2">Test 2</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test3">Test 3</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test4">Test 4</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test5">Test 5</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test6">Test 6</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test7">Test 7</button>
                <button class="project-btn bg-blue-600 hover:bg-blue-700 text-white font-semibold py-12 rounded-lg shadow-md transition-all duration-300" data-project="Test8">Test 8</button>
            </div>
        </main>
    </div>

    <!-- Project Dashboard Screen (hidden initially) -->
    <div id="project-dashboard" class="min-h-screen hidden">
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <img id="project-logo" src="https://via.placeholder.com/150x50.png?text=Logo" alt="Logo" class="h-10 mr-4 logo-clickable">
                    <h1 class="text-2xl font-bold text-gray-900">
                        <span id="project-title">Project Dashboard</span> - Test Observability
                    </h1>
                </div>
                <div class="flex space-x-2">
                    <button id="back-to-dashboard-header" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition duration-150">
                        Back to Dashboard
                    </button>
                    <button class="logout-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition duration-150">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <h2 class="text-xl font-semibold text-gray-800">Test Cases</h2>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                        <div>
                            <label for="search-test" class="block text-sm font-medium text-gray-700 mb-1">Search Test Cases</label>
                            <input type="text" id="search-test" placeholder="Search test cases..." class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="date-filter" class="block text-sm font-medium text-gray-700 mb-1">Filter by Date</label>
                            <input type="date" id="date-filter" class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label>
                            <button id="download-csv-btn" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">Download CSV</button>
                        </div>                        
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Trace</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            </tr>
                        </thead>
                        <tbody id="test-results-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div id="error-container" class="error-message hidden"></div>
                <div class="flex items-center justify-between mt-4">
                    <div class="text-sm text-gray-700">
                        Showing <span id="start-item">1</span> to <span id="end-item">5</span> of <span id="total-items">0</span> results
                    </div>
                    <div class="flex space-x-1" id="pagination-controls">
                        <button id="first-page" class="pagination-btn" disabled>«</button>
                        <button id="prev-page" class="pagination-btn" disabled><</button>
                        <div id="page-numbers" class="flex space-x-1"></div>
                        <button id="next-page" class="pagination-btn" disabled>></button>
                        <button id="last-page" class="pagination-btn" disabled>»</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Test Case History Screen (hidden initially) -->
    <div id="history-screen" class="min-h-screen hidden">
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
                <div class="flex items-center">
                    <img id="history-logo" src="https://via.placeholder.com/150x50.png?text=Logo" alt="Logo" class="h-10 mr-4 logo-clickable">
                    <h1 class="text-2xl font-bold text-gray-900">
                        <span id="test-case-name">Test Case</span> - History
                    </h1>
                </div>
                <div class="flex space-x-2">
                    <button id="back-to-project-header" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition duration-150">
                        Back to Project
                    </button>
                    <button class="logout-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md transition duration-150">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-800 mb-6">Traceability Matrix</h2>
                <div id="timeline-container" class="relative">
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button id="back-to-project" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                    Back to Project
                </button>
                <button id="back-to-dashboard-from-history" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out">
                    Back to Dashboard
                </button>
            </div>
        </main>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-icon" id="chatbot-icon">
        <img src="https://cdn-icons-png.flaticon.com/512/4712/4712109.png" alt="Chatbot" class="w-8 h-8">
    </div>
    
    <div class="chat-window" id="chat-window">
        <div class="bg-blue-600 text-white px-4 py-3 rounded-t-lg flex justify-between items-center">
            <h3 class="font-semibold">Test Data Assistant</h3>
            <button id="close-chat" class="focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="bg-blue-100 text-blue-800 rounded-lg p-3 mb-2 max-w-xs">
                Hello! I can help answer questions about the test data. What would you like to know?
            </div>
        </div>
        <div class="p-3 border-t">
            <div class="flex">
                <input type="text" id="chat-input" placeholder="Type your question..." class="flex-1 border rounded-l-lg px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500">
                <button id="send-chat" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    Send
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentProject = null;
        let currentTestCase = null;
        let testData = [];

        const loginScreen = document.getElementById('login-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        const projectDashboard = document.getElementById('project-dashboard');
        const historyScreen = document.getElementById('history-screen');
        const loginForm = document.getElementById('login-form');
        const projectButtons = document.querySelectorAll('.project-btn');
        const testResultsBody = document.getElementById('test-results-body');
        const projectTitle = document.getElementById('project-title');
        const testCaseName = document.getElementById('test-case-name');
        const timelineContainer = document.getElementById('timeline-container');
        const dateFilter = document.getElementById('date-filter');
        const chatbotIcon = document.getElementById('chatbot-icon');
        const chatWindow = document.getElementById('chat-window');
        const closeChatBtn = document.getElementById('close-chat');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat');
        const searchTestInput = document.getElementById('search-test');
        const firstPageBtn = document.getElementById('first-page');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const lastPageBtn = document.getElementById('last-page');
        const pageNumbersDiv = document.getElementById('page-numbers');
        const startItemSpan = document.getElementById('start-item');
        const endItemSpan = document.getElementById('end-item');
        const totalItemsSpan = document.getElementById('total-items');
        const dashboardLogo = document.getElementById('dashboard-logo');
        const projectLogo = document.getElementById('project-logo');
        const historyLogo = document.getElementById('history-logo');
        const backToDashboardHeader = document.getElementById('back-to-dashboard-header');
        const backToDashboardFromHistory = document.getElementById('back-to-dashboard-from-history');
        const backToProjectBtn = document.getElementById('back-to-project');
        const backToProjectHeader = document.getElementById('back-to-project-header');
        const errorContainer = document.getElementById('error-container');
        const downloadCsvBtn = document.getElementById('download-csv-btn');

        let currentPage = 1;
        const itemsPerPage = 5;

        async function fetchTestData(project) {
            try {
                const response = await fetch(`./${project}/test${project.slice(4)}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status} for ${project}/test${project.slice(4)}.json`);
                }
                const data = await response.json();
                console.log(`Fetched data for ${project}:`, data);
                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error(`Invalid or empty data in ${project}/test${project.slice(4)}.json`);
                }
                return data;
            } catch (error) {
                console.error(`Error fetching test data for ${project}:`, error.message);
                errorContainer.classList.remove('hidden');
                errorContainer.textContent = `Failed to load test data for ${project}. ${error.message}`;
                return [];
            }
        }

        function navigateToDashboard() {
            console.log('Navigating to dashboard');
            if (currentProject) {
                const projectBtn = document.querySelector(`.project-btn[data-project="${currentProject}"]`);
                if (projectBtn) {
                    projectBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    projectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }
            }
            projectDashboard.classList.add('hidden');
            historyScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            currentProject = null;
            testData = [];
            errorContainer.classList.add('hidden');
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === 'password') {
                loginScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');
                chatbotIcon.style.display = 'flex';
            } else {
                alert('Invalid credentials. Please try again.');
            }
        });

        projectButtons.forEach(button => {
            button.addEventListener('click', async function() {
                currentProject = this.getAttribute('data-project');
                console.log(`Loading project: ${currentProject}`);
                projectTitle.textContent = `Test ${currentProject.slice(4)}`;
                
                document.querySelectorAll('.project-btn').forEach(btn => {
                    btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                });
                this.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                this.classList.add('bg-green-600', 'hover:bg-green-700');
                
                errorContainer.classList.add('hidden');
                testData = await fetchTestData(currentProject);
                currentPage = 1;
                dashboardScreen.classList.add('hidden');
                projectDashboard.classList.remove('hidden');
                populateTestResults(testData);
            });
        });

        function populateTestResults(data) {
            console.log('Populating test results with data:', data);
            const searchTerm = searchTestInput.value.toLowerCase();
            let filteredData = data;
            
            if (searchTerm) {
                filteredData = data.filter(item => 
                    item.name?.toLowerCase().includes(searchTerm) || 
                    item.fullName?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (dateFilter.value) {
                filteredData = filteredData.filter(item => item.date === dateFilter.value);
            }
            
            const totalItems = filteredData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            } else if (totalPages === 0) {
                currentPage = 1;
            }
            
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = Math.min(startIdx + itemsPerPage, totalItems);
            const paginatedData = filteredData.slice(startIdx, endIdx);
            
            startItemSpan.textContent = totalItems === 0 ? 0 : startIdx + 1;
            endItemSpan.textContent = endIdx;
            totalItemsSpan.textContent = totalItems;
            
            firstPageBtn.disabled = currentPage === 1;
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastPageBtn.disabled = currentPage === totalPages || totalPages === 0;
            
            pageNumbersDiv.innerHTML = '';
            const maxPagesToShow = 3;
            let startPage = Math.max(1, currentPage - 1);
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => {
                    currentPage = i;
                    populateTestResults(testData);
                });
                pageNumbersDiv.appendChild(pageBtn);
            }
            
            testResultsBody.innerHTML = '';
            
            if (totalItems === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="3" class="px-6 py-4 text-center text-gray-500">
                        No test cases found. Please check the data source or filters.
                    </td>
                `;
                testResultsBody.appendChild(row);
                return;
            }
            
            paginatedData.forEach(test => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'cursor-pointer');
                row.addEventListener('click', () => {
                    showTestCaseHistory(test);
                });
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-blue-600 hover:underline">${test.name || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 max-w-xs truncate" title="${(test.statusTrace || 'No trace').replace(/&/g, '&amp;').replace(/\"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}">${test.statusTrace?.split('\n')[0] || 'No trace'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${test.date || 'N/A'}</div>
                    </td>
                `;
                
                testResultsBody.appendChild(row);
            });
        }

        function showTestCaseHistory(testCase) {
            currentTestCase = testCase;
            testCaseName.textContent = testCase.name || 'Unknown Test Case';
            projectDashboard.classList.add('hidden');
            historyScreen.classList.remove('hidden');

            // Find all test runs with the same name (case-insensitive, trimmed)
            const normalizedName = (testCase.name || '').trim().toLowerCase();
            const allRuns = testData.filter(tc => (tc.name || '').trim().toLowerCase() === normalizedName);

            // Build table HTML with Download CSV button in the header row
            let tableHtml = `<div class="overflow-x-auto mb-4"><table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Trace</th>
                        <th class="px-6 py-3 text-right" style="width:1%">
                            <button id=\"download-csv-btn\" class=\"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition duration-150 ease-in-out\">Download CSV</button>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;
            if (allRuns.length === 0) {
                tableHtml += `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No history found for this test case.</td></tr>`;
            } else {
                allRuns.forEach(run => {
                    tableHtml += `<tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${run.date || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-pre-line text-sm text-gray-700" style="max-width:400px;overflow-x:auto;">${(run.statusTrace || 'No status trace available').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                        <td></td>
                    </tr>`;
                });
            }
            tableHtml += `</tbody></table></div>`;

            timelineContainer.innerHTML = tableHtml;

            // Download CSV logic
            document.getElementById('download-csv-btn').onclick = function() {
                let csv = 'Date,Status Trace\n';
                allRuns.forEach(run => {
                    // Escape quotes and newlines for CSV
                    const date = (run.date || '').replace(/"/g, '""');
                    const trace = (run.statusTrace || '').replace(/"/g, '""').replace(/\n/g, ' ');
                    csv += `"${date}","${trace}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${(testCase.name || 'testcase').replace(/[^a-z0-9]/gi, '_').toLowerCase()}_history.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };
        }

        // Download CSV logic for project dashboard
        downloadCsvBtn.addEventListener('click', function() {
            const searchTerm = searchTestInput.value.toLowerCase();
            let filteredData = testData;
            
            if (searchTerm) {
                filteredData = testData.filter(item => 
                    item.name?.toLowerCase().includes(searchTerm) || 
                    item.fullName?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (dateFilter.value) {
                filteredData = filteredData.filter(item => item.date === dateFilter.value);
            }
            
            let csv = 'Name,Status Trace,Date\n';
            filteredData.forEach(test => {
                const name = (test.name || '').replace(/"/g, '""');
                const trace = (test.statusTrace || '').replace(/"/g, '""').replace(/\n/g, ' ');
                const date = (test.date || '').replace(/"/g, '""');
                csv += `"${name}","${trace}","${date}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(currentProject || 'project').replace(/[^a-z0-9]/gi, '_').toLowerCase()}_test_results.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        backToProjectBtn.addEventListener('click', function() {
            console.log('Navigating back to project dashboard');
            historyScreen.classList.add('hidden');
            projectDashboard.classList.remove('hidden');
        });

        backToProjectHeader.addEventListener('click', function() {
            console.log('Navigating back to project dashboard from header');
            historyScreen.classList.add('hidden');
            projectDashboard.classList.remove('hidden');
        });

        backToDashboardFromHistory.addEventListener('click', navigateToDashboard);

        chatbotIcon.addEventListener('click', function() {
            chatWindow.style.display = 'flex';
        });

        closeChatBtn.addEventListener('click', function() {
            chatWindow.style.display = 'none';
        });

        const qaPairs = [
            {
                question: "What was the most recent test failure?",
                answer: () => `The most recent test failure was "${testData[0]?.name || 'N/A'}" on ${testData[0]?.date || 'N/A'}. The error was: "${testData[0]?.statusTrace?.split('\n')[0] || 'N/A'}".`
            },
            {
                question: "How many test cases failed?",
                answer: () => `There are ${testData.length} failed test cases in the dataset.`
            },
            {
                question: "What are the common issues in test failures?",
                answer: () => `The common issue seems to be elements not being found when attempting to set values. Most errors mention "Can't call setValue on element with selector [something] because element wasn't found".`
            },
            {
                question: "Show all test dates",
                answer: () => `All tests in the dataset were run on: ${testData.map(item => item.date).filter((value, index, self) => self.indexOf(value) === index).join(', ') || 'N/A'}.`
            },
            {
                question: "What failed in login tests?",
                answer: () => {
                    const loginTests = testData.filter(test => test.name?.toLowerCase().includes('login'));
                    return loginTests.length > 0 
                        ? loginTests.map(test => `The login test "${test.name}" failed because: "${test.statusTrace?.split('\n')[0] || 'N/A'}"`).join('\n')
                        : 'No login tests found.';
                }
            },
            {
                question: "List all test names",
                answer: () => `Here are all the test names:\n${testData.map(item => `- ${item.name || 'N/A'}`).join('\n') || 'No tests available.'}`
            },
            {
                question: "What is the trace for shopping cart test?",
                answer: () => {
                    const cartTest = testData.find(test => test.name?.toLowerCase().includes('shopping cart'));
                    return cartTest ? `The shopping cart test "${cartTest.name}" failed with error: "${cartTest.statusTrace || 'N/A'}"` : 'No shopping cart test found.';
                }
            },
            {
                question: "When did product search test fail?",
                answer: () => {
                    const searchTest = testData.find(test => test.name?.toLowerCase().includes('product search'));
                    return searchTest ? `The product search test "${searchTest.name}" failed on ${searchTest.date || 'N/A'}.` : 'No product search test found.';
                }
            },
            {
                question: "Help me analyze test failures",
                answer: () => `Looking at the test failures, the key pattern is that WebDriver can't find the expected elements on the page. This suggests either:
1. The selectors need to be updated
2. The page structure has changed
3. The elements aren't loading in time
The most common elements missing are input fields (username, password, registration, etc.).`
            },
            {
                question: "Summarize test failures",
                answer: () => `Here's a summary of the test failures:
- Total failed tests: ${testData.length}
- Main issue: Element not found (${testData.filter(item => item.statusTrace?.includes("element wasn't found")).length} cases)
- Most affected areas: Login, Registration, Shopping Cart
- Dates: ${testData.map(item => item.date).filter((value, index, self) => self.indexOf(value) === index).join(', ') || 'N/A'}
Key recommendation: Review element selectors and page loading timing.`
            }
        ];

        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-2 ${isUser ? 'ml-auto bg-blue-500 text-white' : 'bg-blue-100 text-blue-800'} rounded-lg p-3 max-w-xs`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                addMessage(message, true);
                chatInput.value = '';
                
                const lowerMessage = message.toLowerCase();
                const match = qaPairs.find(qa => qa.question.toLowerCase().includes(lowerMessage) || lowerMessage.includes(qa.question.toLowerCase()));
                
                setTimeout(() => {
                    if (match) {
                        const answer = typeof match.answer === 'function' ? match.answer() : match.answer;
                        addMessage(answer);
                    } else {
                        addMessage("I'm sorry, I don't understand that question. Try asking about test failures or specific test cases.");
                    }
                }, 500);
            }
        }

        sendChatBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });


        searchTestInput.addEventListener('input', function() {
            currentPage = 1;
            populateTestResults(testData);
        });

        // Update table when date filter changes
        dateFilter.addEventListener('input', function() {
            currentPage = 1;
            populateTestResults(testData);
        });

        firstPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage = 1;
                populateTestResults(testData);
            }
        });

        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                populateTestResults(testData);
            }
        });

        nextPageBtn.addEventListener('click', function() {
            const totalPages = Math.ceil(testData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                populateTestResults(testData);
            }
        });

        lastPageBtn.addEventListener('click', function() {
            const totalPages = Math.ceil(testData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage = totalPages;
                populateTestResults(testData);
            }
        });

        document.querySelectorAll('.logout-btn, #logout-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                dashboardScreen.classList.add('hidden');
                projectDashboard.classList.add('hidden');
                historyScreen.classList.add('hidden');
                loginScreen.classList.remove('hidden');
                chatbotIcon.style.display = 'none';
                chatWindow.style.display = 'none';
                
                if (currentProject) {
                    const projectBtn = document.querySelector(`.project-btn[data-project="${currentProject}"]`);
                    if (projectBtn) {
                        projectBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        projectBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                }
                
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                currentProject = null;
                testData = [];
            });
        });

        backToDashboardHeader.addEventListener('click', navigateToDashboard);

        [dashboardLogo, projectLogo, historyLogo].forEach(button => {
            button.addEventListener('click', navigateToDashboard);
        });

        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>